<?xml version='1.0' encoding='UTF-8'?>
<dunes-script-module name="constructVraApiFilter" result-type="string" api-version="6.0.0" id="cfa8ad97-0771-47b2-ba2c-81a920c19de2" version="0.0.0" allowed-operations="vfe" category-name="com.vmware.pscoe.rba.migration">
  <param n="filter" t="Any"><![CDATA[]]></param>
  <param n="separatorInput" t="string"><![CDATA[]]></param>
  <script encoded="false"><![CDATA[var SPECIAL_CHARACTERS = /['&]/g;
var filterStr = "";
var arr = [];
for (var key in filter) {
    var value = filter[key];
    if (System.getObjectType(value) == "string") {
        if (value.match(SPECIAL_CHARACTERS)) {
            System.log("Name containts special character. Splittnig name to build OData Filter");

            var tokens = value
                .split(SPECIAL_CHARACTERS)
                .filter(function (token) {
                    return token !== "" && !token.match(/^\s+$/);
                });

            var oDataFilter = "startswith(" + key + ", '" + tokens[0] + "')";
            if (tokens.length > 2) {
                for (var i = 1; i < tokens.length - 1; i++) {
                    oDataFilter += " and substringof('" + tokens[i] + "', " + key + ")";
                }
            }

            oDataFilter += " and endswith(" + key + ", '" + tokens[tokens.length - 1] + "')";

            arr.push(oDataFilter);
        } else {
            arr.push(key + " eq '" + value + "'");
        }
    } else {
        arr.push(key + " eq " + value);
    }
}

var separator = separatorInput || "and";
filterStr += arr.join(" " + separator + " ");

return filterStr;]]></script>
</dunes-script-module>