<?xml version='1.0' encoding='UTF-8'?>
<dunes-script-module name="waitForDeploymentRequestStatus" result-type="void" api-version="6.0.0" id="929ac397-da5b-485e-91eb-5a43f9adc9e3" version="0.0.0" allowed-operations="vfe" category-name="com.terasky.utils">
  <param n="deploymentId" t="string"><![CDATA[]]></param>
  <param n="requestId" t="string"><![CDATA[]]></param>
  <param n="timeoutMinutes" t="number"><![CDATA[]]></param>
  <param n="sleepIntervalSeconds" t="number"><![CDATA[]]></param>
  <script encoded="false"><![CDATA[var minuteInterval = 60 / sleepIntervalSeconds
var timeoutCounter = timeoutMinutes * minuteInterval

var status = "inprogress"


while(status == "inprogress" || status == "pending" || status == "initialization" || status == "checking_approval")
{
    pathUri = "/deployment/api/deployments/" + deploymentId + "/requests/" + requestId
    var content = System.getModule("com.terasky.utils").vraGetOperation(pathUri);
    status = JSON.parse(content).status.toLowerCase()
    if(status == "inprogress" || status == "pending" || status == "initialization" || status == "checking_approval")
    {
        System.log("Waiting for the deployment ID: " + deploymentId + " and request ID: " + requestId)
        System.log("Current Status is: " + status)
        System.sleep(1000 * sleepIntervalSeconds)
        timeoutCounter = timeoutCounter - 1
        if(timeoutCounter == 0)
        {
            throw "Timeout has been exceeded: " + timeoutMinutes + " Minutes"
        }
    }
}
if(status.toLowerCase() != "successful")
{
    System.error("Request Status: " + status)
    System.error("Request failed - request ID: " + requestId)
    System.error("Deployment ID: " + deploymentId)
    throw requestId + " has been failed - Request Status: " + status
}
]]></script>
</dunes-script-module>