<?xml version='1.0' encoding='UTF-8'?>
<dunes-script-module name="connectVmNicToLogicalSwitch" result-type="VC:Task" api-version="6.0.0" id="8c2901b3-d323-4ba6-94fa-3939c15eaaac" version="0.0.0" allowed-operations="vfe" category-name="com.terasky.utils">
  <param n="vm" t="VC:VirtualMachine"><![CDATA[]]></param>
  <param n="logicalSwitchName" t="string"><![CDATA[]]></param>
  <param n="nicNumber" t="number"><![CDATA[]]></param>
  <script encoded="false"><![CDATA[// ------- ReconfigVM_Task -------
var vmspec = new VcVirtualMachineConfigSpec(); // Builds config spec object for VirtualMachine
var nicArray = new Array(); // Array holds each of the nic configurations (devicespecs)
var nic = new VcVirtualEthernetCardOpaqueNetworkBackingInfo(); // NIC configuration spec and backing info
var conInfo = new VcVirtualDeviceConnectInfo(true , true , true , 'ok')

var nets = Server.findAllForType('VC:OpaqueNetwork')
//System.debug(nets)
for each(net in nets){
	if((net.name.indexOf(logicalSwitchName) != -1) && net.vimHost.name == vm.vimHost.name){
		System.log('Found a logical Switch with the following details: ' + net.summary);
		nic.opaqueNetworkId = net.summary.opaqueNetworkId
		nic.opaqueNetworkType = net.summary.opaqueNetworkType
		break;
		}
	}

if (nicNumber == null || nicNumber < 0 || nicNumber > 5){
	var nicNumber = 0;
}
var devicespec = new VcVirtualDeviceConfigSpec();
var devices = vm.config.hardware.device;
var actualPos = 0;
for( var i in devices){
	if (System.getModule("com.vmware.library.vc.vm.network").isSupportedNic(devices[i])) {
	    System.log("devices.deviceInfo.summary: '"+devices[i].deviceInfo.summary+"'");
		//if (devices[i].deviceInfo.summary == oldNetworkName) {
		if(actualPos++ == nicNumber){
		    devicespec.device = devices[i];
			devicespec.operation = VcVirtualDeviceConfigSpecOperation.edit;
			devicespec.device.backing = nic;
			devicespec.device.connectable = conInfo
			nicArray.push(devicespec);
	    }
  }
}

vmspec.deviceChange = nicArray;
return vm.reconfigVM_Task(vmspec);]]></script>
</dunes-script-module>