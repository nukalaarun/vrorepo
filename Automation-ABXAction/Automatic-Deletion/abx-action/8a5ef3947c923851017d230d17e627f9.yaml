name: Automatic-Deletion
createdMillis: 1641369660749
updatedMillis: 1653821247449
metadata: {
  }
runtime: python
source: |-
  import requests
  from requests.packages.urllib3.exceptions import InsecureRequestWarning
  requests.packages.urllib3.disable_warnings(InsecureRequestWarning)


  def handler(context, inputs):
      vraurl = context.getSecret(inputs['VRAURL'])
      token = context.getSecret(inputs['token'])
      id = inputs['deploymentId']
      api_version_url = f'{vraurl}/iaas/api/about'
      headers = {
          'accept': "application/json",
          'content-type': "application/json"
      }
      output = requests.get(url=api_version_url, headers=headers, verify=False)
      if output.status_code == 200:
          latest_api_version = output.json()['latestApiVersion']
          apiversion = latest_api_version
      else:
          print(output.status_code)
      iaasUrl = f"{vraurl}/iaas/api/login?apiVersion={apiversion}"
      headers = {
          'accept': "application/json",
          'content-type': "application/json"
      }
      refreshtoken = token
      iaasPayload = f'{{"refreshToken": "{refreshtoken}"}}'
      iaasApiOutput = requests.post(iaasUrl, data=iaasPayload, headers=headers, verify=False)
      if iaasApiOutput.status_code == 200:
          jsondata = iaasApiOutput.json()['token']
          bearerToken = "Bearer " + jsondata
          bearertoken = bearerToken
          url = f'{vraurl}/iaas/api/deployments/{id}?forceDelete=true&apiVersion={apiversion}'
          headers = {
              'accept': "application/json",
              'content-type': "application/json",
              'authorization': bearertoken
          }
          apioutput = requests.delete(url,headers=headers,verify=False)
          if apioutput.status_code == 202:
              print(f'Deployment delete request has been handled for deployment id {id}')
          else:
              print(f'API out is {apioutput.status_code} and reason is {apioutput.json()}')
      else:
          print(iaasApiOutput)
entrypoint: handler
inputs:
  psecret:1e050062-6076-423d-b93b-85570267fa8f: ''
  psecret:398a6f85-30c9-43cd-bf9d-62ec6a1e1f9b: ''
cpuShares: 1024
memoryInMB: 300
timeoutSeconds: 600
deploymentTimeoutSeconds: 900
dependencies: requests
actionType: SCRIPT
provider: on-prem
configuration:
  const_azure-system_managed_identity: false
scmActionContentPath: VRA-Cloud-Actions/Automatic-Deletion.abx
scmSourceContentPath: VRA-Cloud-Actions/Automatic-Deletion.py
system: false
shared: false
scalable: false
asyncDeployed: false
id: 8a5ef3947c923851017d230d17e627f9
orgId: 6a4fc131-a5f4-456d-bf24-cb00e151bb49
projectId: 097ea545-e0dc-42ce-a522-d9419d937801
selfLink: /abx/api/resources/actions/8a5ef3947c923851017d230d17e627f9?projectId=097ea545-e0dc-42ce-a522-d9419d937801
projectName: Cloud-Admin
organizationName: 3ctihz7azt
